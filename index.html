<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live Google Sheets Dashboard</title>

  <!-- Inter font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <!-- Tailwind (Play CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --font-inter: 'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
    html,body{font-family:var(--font-inter);}
    /* subtle gradient background */
    body{background:linear-gradient(135deg,#eef2ff 0%, #dbeafe 100%);}
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-6">

  <!-- Login wrapper and dashboard share the same container; toggled by JS -->
  <div id="app" class="w-full max-w-5xl">

    <!-- LOGIN -->
    <section id="login" class="max-w-md mx-auto bg-white/90 rounded-2xl shadow-2xl p-8">
      <h2 class="text-2xl font-semibold text-slate-800 mb-2">Dashboard Login</h2>
      <p class="text-sm text-slate-500 mb-6">Sign in to view live data from Google Sheets.</p>
      <form id="loginForm" class="space-y-4">
        <div>
          <label class="block text-sm text-slate-600 mb-1">Username</label>
          <input id="username" class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-400" placeholder="admin" autocomplete="username" />
        </div>
        <div>
          <label class="block text-sm text-slate-600 mb-1">Password</label>
          <input id="password" type="password" class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-400" placeholder="••••••" autocomplete="current-password" />
        </div>
        <div id="authError" class="text-sm text-red-600" style="display:none"></div>
        <button type="submit" class="w-full py-2 rounded-lg bg-gradient-to-r from-indigo-600 to-blue-500 text-white font-semibold shadow">Sign in</button>
        <div class="text-xs text-slate-400 mt-2">Use username <code class="bg-slate-100 px-1 rounded">admin</code> and password <code class="bg-slate-100 px-1 rounded">debt123</code></div>
      </form>
    </section>

    <!-- DASHBOARD -->
    <section id="dashboard" class="hidden">
      <header class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-4">
          <div class="p-3 rounded-lg bg-gradient-to-br from-indigo-600 to-blue-500 text-white shadow-lg">
            <!-- icon -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v4a1 1 0 001 1h3m10-6v4a1 1 0 01-1 1h-3m-6 6h6" />
            </svg>
          </div>
          <div>
            <h1 class="text-xl font-semibold text-slate-800">Live Finance Dashboard</h1>
            <p class="text-sm text-slate-500">Connected to Google Sheets — range <span id="rangeLabel" class="font-medium">A17:B22</span></p>
          </div>
        </div>

        <div class="flex items-center gap-4">
          <div id="liveIndicator" class="flex items-center gap-2 px-3 py-1 rounded-full bg-white/80 shadow">
            <span id="liveDot" class="h-3 w-3 rounded-full bg-gray-300"></span>
            <div id="liveText" class="text-sm text-slate-600">Disconnected</div>
          </div>
          <button id="logoutBtn" class="px-3 py-2 rounded-md bg-white border hover:shadow">Logout</button>
        </div>
      </header>

      <main>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div class="md:col-span-2 bg-white rounded-2xl p-4 shadow">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-lg font-semibold text-slate-800">Name & Amount</h2>
              <div class="text-xs text-slate-500">Last: <span id="lastUpdated">—</span></div>
            </div>

            <div class="overflow-x-auto">
              <table id="dataTable" class="min-w-full text-left table-auto">
                <thead>
                  <tr class="text-sm text-slate-500 border-b">
                    <th class="py-2 px-3">Name</th>
                    <th class="py-2 px-3">Amount</th>
                  </tr>
                </thead>
                <tbody id="tableBody">
                  <tr><td colspan="2" class="py-6 text-center text-slate-500">No data available</td></tr>
                </tbody>
                <tfoot id="tableFoot" style="display:none">
                  <tr class="border-t">
                    <td class="py-3 px-3 font-semibold">Total</td>
                    <td id="totalCell" class="py-3 px-3 text-right font-semibold"></td>
                  </tr>
                </tfoot>
              </table>
            </div>

            <div id="connError" class="mt-3 text-sm text-red-600" style="display:none"></div>
            <div id="connUrl" class="mt-3 text-xs text-slate-400" style="display:none">Connected via: <code id="connUrlCode" class="bg-slate-100 px-2 py-1 rounded"></code></div>
          </div>

          <aside class="bg-white rounded-2xl p-4 shadow flex flex-col gap-3">
            <div>
              <h3 class="text-sm text-slate-600">Status</h3>
              <p id="statusSmall" class="text-sm text-slate-800 mt-1">Waiting for connection…</p>
            </div>

            <div>
              <h3 class="text-sm text-slate-600">Settings</h3>
              <p class="text-xs text-slate-500 mt-1">Auto-refresh: <span class="font-medium">3s</span></p>
            </div>

            <div>
              <h3 class="text-sm text-slate-600">Info</h3>
              <p class="text-xs text-slate-500 mt-1">Range: <span id="infoRange">A17:B22</span></p>
            </div>
          </aside>
        </div>
      </main>
    </section>

  </div>

<script>
/* ----------------- CONFIG ----------------- */
const SHEET_ID = '1F70kpbSp7tOQ5QLGnn-HLTxQlbT7X5aoK1hu2V8hEW4';
const GID = '0'; // sheet gid (0 for first sheet)
const RANGE = 'A17:B22';
const POLL_INTERVAL_MS = 3000;
const VALID_USERNAME = 'admin';
const VALID_PASSWORD = 'debt123';

/* ----------------- UTILITIES ----------------- */
const nf = new Intl.NumberFormat();
function formatNumberMaybe(val){
  if (val === null || val === undefined || val === '') return '';
  const num = Number(String(val).toString().replace(/,/g, '').trim());
  if (Number.isFinite(num)) return nf.format(num);
  return String(val);
}

function buildCsvUrls(sheetId, gid, range){
  const encodedRange = encodeURIComponent(range);
  return [
    `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&range=${encodedRange}&gid=${gid}`,
    `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}&range=${encodedRange}`,
    `https://docs.google.com/spreadsheets/d/${sheetId}/pub?output=csv&gid=${gid}&range=${encodedRange}`
  ];
}

/* Minimal CSV parser (supports quoted fields) */
function parseCsv(text){
  const rows = [];
  let i=0, cur='', row=[], inQuotes=false;
  while(i<text.length){
    const ch = text[i];
    if (inQuotes){
      if (ch === '"'){
        if (i+1 < text.length && text[i+1] === '"'){ cur += '"'; i+=2; continue; }
        inQuotes = false; i++; continue;
      } else { cur += ch; i++; continue; }
    }
    if (ch === '"'){ inQuotes = true; i++; continue; }
    if (ch === ','){ row.push(cur); cur=''; i++; continue; }
    if (ch === '\r'){ i++; continue; }
    if (ch === '\n'){ row.push(cur); rows.push(row); row=[]; cur=''; i++; continue; }
    cur += ch; i++;
  }
  if (cur !== '' || row.length>0){ row.push(cur); rows.push(row); }
  return rows;
}

/* Fetch CSV with fallbacks */
async function fetchCsvWithFallbacks(urls){
  let lastErr = null;
  for (const url of urls){
    try{
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP '+res.status);
      const text = await res.text();
      if (!text || text.trim().length === 0) throw new Error('Empty response');
      return { url, text };
    }catch(err){ lastErr = err; }
  }
  throw lastErr || new Error('All fallbacks failed');
}

/* ----------------- APP STATE ----------------- */
let pollInterval = null;
let controller = null;
let connectedUrl = null;

/* ----------------- DOM Helpers ----------------- */
const loginEl = document.getElementById('login');
const dashboardEl = document.getElementById('dashboard');
const loginForm = document.getElementById('loginForm');
const authError = document.getElementById('authError');
const tableBody = document.getElementById('tableBody');
const tableFoot = document.getElementById('tableFoot');
const totalCell = document.getElementById('totalCell');
const lastUpdatedEl = document.getElementById('lastUpdated');
const liveDot = document.getElementById('liveDot');
const liveText = document.getElementById('liveText');
const connError = document.getElementById('connError');
const connUrl = document.getElementById('connUrl');
const connUrlCode = document.getElementById('connUrlCode');
const statusSmall = document.getElementById('statusSmall');
const logoutBtn = document.getElementById('logoutBtn');

// show range labels
document.getElementById('rangeLabel').innerText = RANGE;
document.getElementById('infoRange').innerText = RANGE;

/* ----------------- AUTH ----------------- */
loginForm.addEventListener('submit', function(e){
  e.preventDefault();
  const u = document.getElementById('username').value.trim();
  const p = document.getElementById('password').value;
  authError.style.display = 'none';
  if (u === VALID_USERNAME && p === VALID_PASSWORD){
    // show dashboard
    loginEl.classList.add('hidden');
    dashboardEl.classList.remove('hidden');
    startPolling();
  } else {
    authError.innerText = 'Invalid username or password.';
    authError.style.display = 'block';
  }
});

logoutBtn.addEventListener('click', function(){
  stopPolling();
  dashboardEl.classList.add('hidden');
  loginEl.classList.remove('hidden');
});

/* ----------------- POLLING & RENDER ----------------- */
function setLive(connected){
  if (connected){
    liveDot.classList.remove('bg-gray-300');
    liveDot.classList.add('bg-green-400');
    liveText.innerText = 'Live';
    statusSmall.innerText = 'Receiving live updates.';
  } else {
    liveDot.classList.remove('bg-green-400');
    liveDot.classList.add('bg-gray-300');
    liveText.innerText = 'Disconnected';
    statusSmall.innerText = 'Disconnected or no data.';
  }
}

async function doFetch(){
  if (!SHEET_ID || SHEET_ID.includes('[your-sheet-id]')){
    connError.style.display = 'block';
    connError.innerText = 'Please replace the SHEET_ID placeholder in the script with your sheet id.';
    setLive(false);
    renderNoData();
    return;
  }

  if (controller) controller.abort();
  controller = new AbortController();
  const urls = buildCsvUrls(SHEET_ID, GID, RANGE);
  try{
    connError.style.display = 'none';
    const { url, text } = await fetchCsvWithFallbacks(urls);
    connectedUrl = url;
    connUrl.style.display = 'block';
    connUrlCode.innerText = url;
    setLive(true);
    lastUpdatedEl.innerText = new Date().toLocaleString();

    const parsed = parseCsv(text);
    const processed = [];
    for (const r of parsed){
      if (!r || r.length === 0) continue;
      const name = (r[0] || '').trim();
      const amountRaw = (r[1] || '').trim();
      if (!name && !amountRaw) continue;
      processed.push({ name, amountRaw });
    }
    // header detection
    if (processed.length > 0){
      const first = processed[0];
      if (String(first.name).toLowerCase().includes('name') || String(first.amountRaw).toLowerCase().includes('amount')) processed.shift();
    }

    const finalRows = processed.map(r => {
      const cleaned = (r.amountRaw || '').replace(/[^0-9.\-+,]/g, '').replace(/,/g, '');
      const num = Number(cleaned);
      return { name: r.name || '', amountRaw: r.amountRaw || '', amount: Number.isFinite(num) ? num : null };
    });

    renderRows(finalRows);
  }catch(err){
    connectedUrl = null;
    connUrl.style.display = 'none';
    connError.style.display = 'block';
    connError.innerText = 'Connection error: '+(err.message || err);
    setLive(false);
    renderNoData();
  }
}

function renderRows(rows){
  tableBody.innerHTML = '';
  if (!rows || rows.length === 0){
    renderNoData();
    return;
  }
  let total = 0;
  rows.forEach((r, idx) =>{
    const tr = document.createElement('tr');
    tr.className = 'hover:bg-slate-50 transition';
    const td1 = document.createElement('td'); td1.className='py-3 px-3 text-slate-700'; td1.innerText = r.name || '—';
    const td2 = document.createElement('td'); td2.className='py-3 px-3 text-right font-medium'; td2.innerText = r.amount !== null ? formatNumberMaybe(r.amount) : formatNumberMaybe(r.amountRaw);
    tr.appendChild(td1); tr.appendChild(td2);
    tableBody.appendChild(tr);
    if (Number.isFinite(r.amount)) total += r.amount;
  });
  totalCell.innerText = formatNumberMaybe(total);
  tableFoot.style.display = 'table-footer-group';
}

function renderNoData(){
  tableBody.innerHTML = '<tr><td colspan="2" class="py-6 text-center text-slate-500">No data available</td></tr>';
  tableFoot.style.display = 'none';
  totalCell.innerText = '';
}

function startPolling(){
  // immediate
  doFetch();
  if (pollInterval) clearInterval(pollInterval);
  pollInterval = setInterval(doFetch, POLL_INTERVAL_MS);
}
function stopPolling(){
  if (pollInterval) clearInterval(pollInterval);
  pollInterval = null;
  if (controller) controller.abort();
  controller = null;
  setLive(false);
}

/* ----------------- Basic client-side security: prevent right-click & F12 ----------------- */
document.addEventListener('contextmenu', e => e.preventDefault());
document.addEventListener('keydown', e => {
  if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'i')){
    e.preventDefault();
  }
});

/* If user navigates away, clean up */
window.addEventListener('beforeunload', () => { stopPolling(); });
</script>

</body>
</html>
