<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exchange Office Dashboard - Version 8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .pulse-dot { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md fade-in">
            <div class="text-center mb-8">
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">Exchange Office</h1>
                <p class="text-gray-600 mt-2">Dashboard Login</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="username" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" placeholder="Enter username" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" placeholder="Enter password" required>
                </div>
                
                <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 rounded-lg font-medium hover:from-blue-700 hover:to-indigo-700 transform hover:scale-105 transition-all duration-200 shadow-lg">
                    Sign In
                </button>
            </form>
            
            <div id="loginError" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden">
                Invalid credentials. Please try again.
            </div>
            
            <div id="lockoutMessage" class="mt-4 p-3 bg-yellow-100 border border-yellow-400 text-yellow-700 rounded-lg hidden">
                Too many failed attempts. Please wait <span id="lockoutTimer">5</span> minutes.
            </div>
        </div>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboardPage" class="hidden min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 w-8 h-8 rounded-lg flex items-center justify-center mr-3">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                            </svg>
                        </div>
                        <h1 class="text-xl font-semibold text-gray-800">Exchange Office Dashboard</h1>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center text-sm text-gray-600">
                            <div class="w-2 h-2 bg-green-500 rounded-full pulse-dot mr-2"></div>
                            <span>Live Data</span>
                        </div>
                        <div class="text-sm text-gray-600">
                            <span id="userRole">User</span> | Session: <span id="sessionTimer">30:00</span>
                        </div>
                        <button id="logoutBtn" class="text-gray-600 hover:text-gray-800 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Spreadsheet Content -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 mb-8">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-800">Spreadsheet Data</h2>
                    <p class="text-sm text-gray-600">Live data from Google Sheets - Last updated: <span id="lastUpdated">Loading...</span></p>
                </div>
                <div class="overflow-x-auto" style="height: 600px;">
                    <iframe src="https://docs.google.com/spreadsheets/d/e/2PACX-1vS-Pnmq4_49hiJO5QlPLU9BKRkMyk5RwKTaicnfbJamYG7WanCUEBl-v2KnJ7F7LkOk3Jmy0FuuHCQZ/pubhtml" height="600" class="h-full w-full"></iframe>
                </div>
            </div>






        </main>
        
        <!-- Footer with Exchange Rates -->
        <footer class="bg-gradient-to-r from-green-500 to-blue-600 text-white p-6 mt-8">
            <div class="max-w-7xl mx-auto">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold">Live Exchange Rates</h2>
                    <div class="flex items-center text-sm">
                        <div id="apiStatus" class="w-2 h-2 bg-green-300 rounded-full pulse-dot mr-2"></div>
                        <span id="apiStatusText">Real-time API</span>
                    </div>
                </div>
                <div id="liveRatesGrid" class="grid grid-cols-2 md:grid-cols-5 lg:grid-cols-10 gap-4">
                    <!-- Live rates will be populated here -->
                </div>
                <div class="text-center mt-4 text-sm opacity-75">
                    Updated every 30 seconds
                </div>
            </div>
        </footer>
    </div>



    <script>
        // Enhanced Security Features
        
        // Simple encryption function
        function encrypt(text, key = 'exchangeKey2024') {
            let result = '';
            for (let i = 0; i < text.length; i++) {
                result += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
            }
            return btoa(result);
        }
        
        function decrypt(encrypted, key = 'exchangeKey2024') {
            const decoded = atob(encrypted);
            let result = '';
            for (let i = 0; i < decoded.length; i++) {
                result += String.fromCharCode(decoded.charCodeAt(i) ^ key.charCodeAt(i % key.length));
            }
            return result;
        }
        
        // User credentials - now working correctly
        const users = [
            { username: 'admin', password: 'exchange123', role: 'Administrator' },
            { username: 'manager', password: 'manager456', role: 'Manager' },
            { username: 'operator', password: 'operator789', role: 'Operator' }
        ];

        // Security variables
        let loginAttempts = parseInt(localStorage.getItem('loginAttempts') || '0');
        let lockoutTime = parseInt(localStorage.getItem('lockoutTime') || '0');
        let sessionTimeout;
        let sessionTimer;
        let sessionTimeLeft = 30 * 60; // 30 minutes in seconds

        // DOM elements
        const loginPage = document.getElementById('loginPage');
        const dashboardPage = document.getElementById('dashboardPage');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const lockoutMessage = document.getElementById('lockoutMessage');
        const logoutBtn = document.getElementById('logoutBtn');
        const sessionTimerDisplay = document.getElementById('sessionTimer');

        // Check if user is locked out on page load
        checkLockoutStatus();

        // Enhanced login form handler with rate limiting
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Check if user is locked out
            if (Date.now() < lockoutTime) {
                showLockoutMessage();
                return;
            }
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Check against all users
            const validUser = users.find(user => 
                user.username === username && user.password === password
            );
            
            if (validUser) {
                // Successful login
                loginAttempts = 0;
                localStorage.removeItem('loginAttempts');
                localStorage.removeItem('lockoutTime');
                
                loginPage.classList.add('hidden');
                dashboardPage.classList.remove('hidden');
                loginError.classList.add('hidden');
                lockoutMessage.classList.add('hidden');
                
                // Set user role
                document.getElementById('userRole').textContent = validUser.role;
                
                // Start session management
                startSession();
                startDataUpdates();
            } else {
                // Failed login
                loginAttempts++;
                localStorage.setItem('loginAttempts', loginAttempts.toString());
                
                if (loginAttempts >= 3) {
                    // Lock out for 5 minutes after 3 failed attempts
                    lockoutTime = Date.now() + (5 * 60 * 1000);
                    localStorage.setItem('lockoutTime', lockoutTime.toString());
                    showLockoutMessage();
                } else {
                    loginError.textContent = `Invalid credentials. ${3 - loginAttempts} attempts remaining.`;
                    loginError.classList.remove('hidden');
                }
                
                // Clear form
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
            }
        });

        function checkLockoutStatus() {
            if (Date.now() < lockoutTime) {
                showLockoutMessage();
            }
        }

        function showLockoutMessage() {
            const timeLeft = Math.ceil((lockoutTime - Date.now()) / 1000 / 60);
            document.getElementById('lockoutTimer').textContent = timeLeft;
            lockoutMessage.classList.remove('hidden');
            loginError.classList.add('hidden');
            
            // Update timer every minute
            const lockoutTimer = setInterval(() => {
                const timeLeft = Math.ceil((lockoutTime - Date.now()) / 1000 / 60);
                if (timeLeft <= 0) {
                    lockoutMessage.classList.add('hidden');
                    localStorage.removeItem('lockoutTime');
                    lockoutTime = 0;
                    clearInterval(lockoutTimer);
                } else {
                    document.getElementById('lockoutTimer').textContent = timeLeft;
                }
            }, 60000);
        }

        function startSession() {
            // Auto-logout after 30 minutes
            sessionTimeout = setTimeout(() => {
                logout();
                alert('Session expired. Please login again.');
            }, 30 * 60 * 1000);

            // Update session timer display
            sessionTimer = setInterval(() => {
                sessionTimeLeft--;
                const minutes = Math.floor(sessionTimeLeft / 60);
                const seconds = sessionTimeLeft % 60;
                sessionTimerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (sessionTimeLeft <= 0) {
                    logout();
                    alert('Session expired. Please login again.');
                }
            }, 1000);
        }

        function logout() {
            clearTimeout(sessionTimeout);
            clearInterval(sessionTimer);
            
            dashboardPage.classList.add('hidden');
            loginPage.classList.remove('hidden');
            
            // Clear form
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            
            // Reset session timer
            sessionTimeLeft = 30 * 60;
            
            stopDataUpdates();
        }

        // Logout button handler
        logoutBtn.addEventListener('click', logout);

        // Prevent right-click and developer tools (basic protection)
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('keydown', e => {
            if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I')) {
                e.preventDefault();
            }
        });

        // Clear sensitive data on page unload
        window.addEventListener('beforeunload', () => {
            // Clear any sensitive data from memory
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        });

        // Google Sheets Integration
        const GOOGLE_SHEETS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS-Pnmq4_49hiJO5QlPLU9BKRkMyk5RwKTaicnfbJamYG7WanCUEBl-v2KnJ7F7LkOk3Jmy0FuuHCQZ/pub?output=csv';
        
        // Using your published Google Sheet URL
        
        async function fetchGoogleSheetData() {
            try {
                const response = await fetch(GOOGLE_SHEETS_URL);
                const text = await response.text();
                return parseCSV(text);
            } catch (error) {
                console.error('Error fetching Google Sheets data:', error);
                return null;
            }
        }
        
        function parseCSV(text) {
            const lines = text.split('\n');
            const result = [];
            for (let line of lines) {
                if (line.trim()) {
                    result.push(line.split(','));
                }
            }
            return result;
        }
        
        async function fetchSpreadsheetData() {
            const data = await fetchGoogleSheetData();
            return data;
        }
        
        // Fallback mock data functions
        function generateMockStatistics() {
            return {
                totalTransactions: Math.floor(Math.random() * 1000) + 500,
                dailyRevenue: '$' + (Math.random() * 50000 + 10000).toFixed(2),
                activeRates: Math.floor(Math.random() * 20) + 15,
                pendingOrders: Math.floor(Math.random() * 50) + 5
            };
        }
        
        // Real-time exchange rate data
        let previousRates = {};
        
        async function fetchRealExchangeRates() {
            try {
                // Using exchangerate-api.com (free tier allows 1500 requests/month)
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/AFN');
                const data = await response.json();
                
                if (data && data.rates) {
                    updateApiStatus(true);
                    return calculateAfghanRates(data.rates);
                } else {
                    throw new Error('Invalid API response');
                }
            } catch (error) {
                console.error('Error fetching real exchange rates:', error);
                updateApiStatus(false);
                // Fallback to mock data if API fails
                return generateFallbackRates();
            }
        }
        
        function updateApiStatus(isOnline) {
            const statusDot = document.getElementById('apiStatus');
            const statusText = document.getElementById('apiStatusText');
            
            if (isOnline) {
                statusDot.className = 'w-2 h-2 bg-green-300 rounded-full pulse-dot mr-2';
                statusText.textContent = 'Real-time API';
            } else {
                statusDot.className = 'w-2 h-2 bg-yellow-300 rounded-full pulse-dot mr-2';
                statusText.textContent = 'Fallback Data';
            }
        }
        
        function calculateAfghanRates(rates) {
            // Convert rates to AFN base and calculate buy/sell spreads
            const currencies = [
                { code: 'USD', name: 'دالر امریکا' },
                { code: 'PKR', name: 'روپیه پاکستان' },
                { code: 'IRR', name: 'ریال ایران' },
                { code: 'GBP', name: 'پوند انگلیس' },
                { code: 'EUR', name: 'یورو اروپا' },
                { code: 'INR', name: 'روپیه هند' },
                { code: 'CNY', name: 'یوان چین' },
                { code: 'SAR', name: 'ریال سعودی' },
                { code: 'AED', name: 'درهم امارات' },
                { code: 'TRY', name: 'لیره ترکیه' }
            ];
            
            return currencies.map(currency => {
                const rate = rates[currency.code];
                if (!rate) return null;
                
                // Convert to AFN base (1 foreign currency = X AFN)
                const baseRate = 1 / rate;
                
                // Add typical exchange office spread (2-3%)
                const spread = 0.025;
                const buyRate = baseRate * (1 - spread);
                const sellRate = baseRate * (1 + spread);
                
                // Calculate change from previous rate
                let change = 0;
                if (previousRates[currency.code]) {
                    const previousRate = previousRates[currency.code];
                    change = ((baseRate - previousRate) / previousRate * 100);
                }
                previousRates[currency.code] = baseRate;
                
                return {
                    currency: currency.name,
                    code: currency.code,
                    buyRate: formatRate(buyRate, currency.code),
                    sellRate: formatRate(sellRate, currency.code),
                    change: change.toFixed(2)
                };
            }).filter(rate => rate !== null);
        }
        
        function formatRate(rate, currencyCode) {
            // Format rates based on typical values
            if (['IRR'].includes(currencyCode)) {
                return rate.toFixed(6);
            } else if (['PKR', 'INR'].includes(currencyCode)) {
                return rate.toFixed(4);
            } else if (['TRY'].includes(currencyCode)) {
                return rate.toFixed(3);
            } else {
                return rate.toFixed(2);
            }
        }
        
        function generateFallbackRates() {
            // Fallback rates if API fails
            return [
                {
                    currency: 'دالر امریکا',
                    buyRate: (70.5 + Math.random() * 2).toFixed(2),
                    sellRate: (71.2 + Math.random() * 2).toFixed(2),
                    change: (Math.random() * 2 - 1).toFixed(2)
                },
                {
                    currency: 'روپیه پاکستان',
                    buyRate: (0.25 + Math.random() * 0.05).toFixed(4),
                    sellRate: (0.26 + Math.random() * 0.05).toFixed(4),
                    change: (Math.random() * 2 - 1).toFixed(2)
                },
                {
                    currency: 'ریال ایران',
                    buyRate: (0.0017 + Math.random() * 0.0003).toFixed(6),
                    sellRate: (0.0018 + Math.random() * 0.0003).toFixed(6),
                    change: (Math.random() * 2 - 1).toFixed(2)
                },
                {
                    currency: 'پوند انگلیس',
                    buyRate: (88.5 + Math.random() * 3).toFixed(2),
                    sellRate: (89.8 + Math.random() * 3).toFixed(2),
                    change: (Math.random() * 2 - 1).toFixed(2)
                },
                {
                    currency: 'یورو اروپا',
                    buyRate: (76.2 + Math.random() * 2.5).toFixed(2),
                    sellRate: (77.1 + Math.random() * 2.5).toFixed(2),
                    change: (Math.random() * 2 - 1).toFixed(2)
                },
                {
                    currency: 'روپیه هند',
                    buyRate: (0.85 + Math.random() * 0.1).toFixed(4),
                    sellRate: (0.87 + Math.random() * 0.1).toFixed(4),
                    change: (Math.random() * 2 - 1).toFixed(2)
                },
                {
                    currency: 'یوان چین',
                    buyRate: (9.8 + Math.random() * 1).toFixed(2),
                    sellRate: (10.1 + Math.random() * 1).toFixed(2),
                    change: (Math.random() * 2 - 1).toFixed(2)
                },
                {
                    currency: 'ریال سعودی',
                    buyRate: (18.8 + Math.random() * 2).toFixed(2),
                    sellRate: (19.2 + Math.random() * 2).toFixed(2),
                    change: (Math.random() * 2 - 1).toFixed(2)
                },
                {
                    currency: 'درهم امارات',
                    buyRate: (19.2 + Math.random() * 2).toFixed(2),
                    sellRate: (19.6 + Math.random() * 2).toFixed(2),
                    change: (Math.random() * 2 - 1).toFixed(2)
                },
                {
                    currency: 'لیره ترکیه',
                    buyRate: (2.1 + Math.random() * 0.3).toFixed(3),
                    sellRate: (2.2 + Math.random() * 0.3).toFixed(3),
                    change: (Math.random() * 2 - 1).toFixed(2)
                }
            ];
        }
        
        // Data update functions
        let updateInterval;

        async function updateDashboardData() {
            // Fetch spreadsheet data
            const spreadsheetData = await fetchSpreadsheetData();
            
            // Update last updated time
            document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
            
            // Update spreadsheet table
            if (spreadsheetData && spreadsheetData.length > 0) {
                populateSpreadsheetTable(spreadsheetData);
            }
            
            // Update live rates widget with real data
            const exchangeRates = await fetchRealExchangeRates();
            updateLiveRatesWidget(exchangeRates);
        }
        
        function populateSpreadsheetTable(data) {
            const tableHead = document.getElementById('spreadsheetTableHead');
            const tableBody = document.getElementById('spreadsheetTableBody');
            
            // Clear existing content
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';
            
            if (data.length === 0) return;
            
            // Create headers from first row
            const headerRow = document.createElement('tr');
            const firstRow = data[0];
            
            firstRow.forEach(header => {
                const th = document.createElement('th');
                th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                th.textContent = header || 'Column';
                headerRow.appendChild(th);
            });
            tableHead.appendChild(headerRow);
            
            // Create data rows
            data.slice(1).forEach(row => {
                const tr = document.createElement('tr');
                row.forEach(cell => {
                    const td = document.createElement('td');
                    td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-900';
                    td.textContent = cell || '';
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        }
        
        function updateLiveRatesWidget(rates) {
            const liveRatesGrid = document.getElementById('liveRatesGrid');
            liveRatesGrid.innerHTML = '';
            
            rates.forEach(rate => {
                const changeClass = parseFloat(rate.change) >= 0 ? 'text-green-200' : 'text-red-200';
                const changeIcon = parseFloat(rate.change) >= 0 ? '↗' : '↘';
                
                const rateCard = document.createElement('div');
                rateCard.className = 'bg-white bg-opacity-20 rounded-lg p-3 text-center';
                rateCard.innerHTML = `
                    <div class="text-sm font-medium opacity-90">${rate.currency}</div>
                    <div class="text-lg font-bold">${rate.sellRate}</div>
                `;
                liveRatesGrid.appendChild(rateCard);
            });
        }

        function startDataUpdates() {
            updateDashboardData();
            updateInterval = setInterval(updateDashboardData, 30000);
        }

        function stopDataUpdates() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        }


    </script>
</body>
</html>
